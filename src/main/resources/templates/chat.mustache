<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <title>Real-Time Chat</title>
    <style>
        #messages {
            border: 1px solid #ccc;
            padding: 10px;
            height: 200px;
            overflow-y: scroll;
            margin-top: 10px;
        }
        #controls, #auth-section {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
<h2>Real-Time Chat</h2>

<!-- âœ… JWT ì¸ì¦ -->
<div id="auth-section">
    <h3>Enter Your Token</h3>
    <input type="text" id="authToken" placeholder="Enter your JWT token">
    <button id="confirmTokenButton">í™•ì¸</button>
    <p id="displayToken" style="word-break: break-all;"></p>
</div>

<!-- âœ… ì±„íŒ… ë©”ì‹œì§€ ì…ë ¥ -->
<div id="controls">
    <h3>Chat</h3>
    <input type="text" id="messageInput" placeholder="Enter your message">
    <button id="sendButton" disabled>Send</button>
</div>

<!-- âœ… ì±„íŒ… ë©”ì‹œì§€ í‘œì‹œ -->
<div id="messages"></div>

<script>
    let stompClient = null;
    let chatRoomId = "1234";  // âœ… ë°© IDë¥¼ 1234ë¡œ ê³ ì •
    let username = "User1";   // âœ… ì„ì˜ì˜ ì‚¬ìš©ì ì´ë¦„ ì„¤ì •

    document.addEventListener("DOMContentLoaded", function () {
        console.log("âœ… [DOMContentLoaded] í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ");

        document.getElementById("confirmTokenButton").addEventListener("click", function () {
            const token = getAuthToken();
            if (!token) {
                alert("í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }
            console.log("ğŸ”¹ [í™•ì¸ ë²„íŠ¼ í´ë¦­] ì…ë ¥í•œ í† í°:", token);
            document.getElementById('displayToken').textContent = "ğŸ”‘ ì…ë ¥í•œ í† í°: " + token;
            initializeWebSocket();
        });

        document.getElementById('sendButton').addEventListener('click', sendMessage);
    });

    function getAuthToken() {
        return document.getElementById('authToken').value.trim();
    }

    function displayMessage(sender, message) {
        const messagesDiv = document.getElementById('messages');
        const messageElement = document.createElement('div');
        messageElement.textContent = `${sender}: ${message}`;
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function joinRoom() {
        if (!stompClient || !stompClient.connected) {
            alert("WebSocketì´ ì•„ì§ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return;
        }

        const token = getAuthToken();
        if (!token) {
            alert("í† í°ì„ ì…ë ¥í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”!");
            return;
        }

        document.getElementById('messages').innerHTML = ''; // âœ… ë©”ì‹œì§€ ì˜ì—­ ì´ˆê¸°í™”

        // âœ… ë°© êµ¬ë… ì„¤ì •
        stompClient.subscribe(
                `/topic/chat/${chatRoomId}`,
                function (message) {
                    const msg = JSON.parse(message.body);
                    displayMessage(msg.sender, msg.content);
                },
                { "Authorization": `Bearer ${token}` }  // âœ… Authorization í—¤ë” ì¶”ê°€
        );

        console.log(`ğŸ”¹ [ì±„íŒ…ë°© ì…ì¥] ë°© ID: ${chatRoomId}`);

        // âœ… ì„œë²„ì— ìœ ì € ì…ì¥ ë©”ì‹œì§€ ì „ì†¡
        stompClient.send(
                `/app/send/${chatRoomId}`,
                { "Authorization": `Bearer ${token}` },
                JSON.stringify({
                    sender: username,
                    content: `${username} ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.`,
                    roomId: chatRoomId
                })
        );

        alert(`ì±„íŒ…ë°© ${chatRoomId}ì— ì…ì¥í•˜ì˜€ìŠµë‹ˆë‹¤.`);
        document.getElementById('sendButton').disabled = false;
    }

    function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const messageContent = messageInput.value.trim();

        if (!messageContent || !chatRoomId) {
            console.warn("âŒ ë©”ì‹œì§€ ë‚´ìš©ì´ ì—†ê±°ë‚˜, ì±„íŒ…ë°©ì´ ì„ íƒë˜ì§€ ì•ŠìŒ.");
            return;
        }

        if (!stompClient || !stompClient.connected) {
            console.warn("âŒ WebSocketì´ ì—°ê²°ë˜ì§€ ì•ŠìŒ.");
            alert("WebSocketì´ ì•„ì§ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return;
        }

        const token = getAuthToken();
        if (!token) {
            console.warn("âŒ í† í°ì´ ì—†ìŒ.");
            alert("í† í°ì„ ì…ë ¥í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”!");
            return;
        }

        console.log(`ğŸ”¹ ë©”ì‹œì§€ ì „ì†¡: ë°© ID ${chatRoomId}, ë³´ë‚¸ ì‚¬ëŒ ${username}, ë‚´ìš© ${messageContent}`);

        stompClient.send(
                `/app/send/${chatRoomId}`,
                { "Authorization": `Bearer ${token}` },
                JSON.stringify({
                    sender: username,
                    content: messageContent,
                    roomId: chatRoomId
                })
        );

        messageInput.value = '';
    }

    function initializeWebSocket() {
        console.log("ğŸ”¹ [initializeWebSocket] WebSocket ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤...");

        const token = getAuthToken();
        if (!token) {
            alert("í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            return;
        }

        const port = window.location.port || "8081"; // âœ… í˜„ì¬ ì ‘ì†ëœ í¬íŠ¸ í™•ì¸, ê¸°ë³¸ê°’ 8081
        const socket = new SockJS(`http://${window.location.hostname}:8080/ws`);
        stompClient = Stomp.over(socket);

        // âœ… STOMP connect ì‹œ Authorization í—¤ë” í¬í•¨
        stompClient.connect(
                { "Authorization": `Bearer ${token}` },
                function (frame) {
                    console.log("âœ… WebSocket ì—°ê²° ì„±ê³µ:", frame);
                    joinRoom();  // âœ… WebSocket ì—°ê²° í›„ ì±„íŒ…ë°© ìë™ ì…ì¥
                },
                function (error) {
                    console.error("âŒ WebSocket ì—°ê²° ì‹¤íŒ¨:", error);
                }
        );
    }
</script>
</body>
</html>
